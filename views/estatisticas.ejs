<!DOCTYPE html>
<html>
<head>  <title>Estat√≠sticas - Peladas das Quintas Feiras</title>
  <link rel="stylesheet" href="/style.css?v=20250101">
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="shortcut icon" href="/logo.svg">
</head>
<body class="main-bg">
  <%- include('partials/header', { user: user, activePage: 'estatisticas' }) %>

  <main class="container">    <h2 class="section-title">üìä Estat√≠sticas dos Jogadores</h2>

    <!-- Filtros Horizontais -->
    <div class="stats-filters-horizontal">
      <div class="filter-item">
        <label for="ano">üìÖ Ano</label>
        <select id="ano" onchange="updateEstats()" class="filter-select">
          <option value="2024" <%= anoSelecionado === '2024' ? 'selected' : '' %>>2024</option>
          <option value="2025" <%= anoSelecionado === '2025' ? 'selected' : '' %>>2025</option>
          <option value="2026" <%= anoSelecionado === '2026' ? 'selected' : '' %>>2026</option>
          <option value="2027" <%= anoSelecionado === '2027' ? 'selected' : '' %>>2027</option>
        </select>
      </div>
      <div class="filter-item">
        <label for="mes">üìÜ M√™s</label>
        <select id="mes" onchange="updateEstats()" class="filter-select">
          <option value="" <%= mesSelecionado === '' ? 'selected' : '' %>>Todos</option>
          <option value="1" <%= mesSelecionado === '1' ? 'selected' : '' %>>Janeiro</option>
          <option value="2" <%= mesSelecionado === '2' ? 'selected' : '' %>>Fevereiro</option>
          <option value="3" <%= mesSelecionado === '3' ? 'selected' : '' %>>Mar√ßo</option>
          <option value="4" <%= mesSelecionado === '4' ? 'selected' : '' %>>Abril</option>
          <option value="5" <%= mesSelecionado === '5' ? 'selected' : '' %>>Maio</option>
          <option value="6" <%= mesSelecionado === '6' ? 'selected' : '' %>>Junho</option>
          <option value="7" <%= mesSelecionado === '7' ? 'selected' : '' %>>Julho</option>
          <option value="8" <%= mesSelecionado === '8' ? 'selected' : '' %>>Agosto</option>
          <option value="9" <%= mesSelecionado === '9' ? 'selected' : '' %>>Setembro</option>
          <option value="10" <%= mesSelecionado === '10' ? 'selected' : '' %>>Outubro</option>
          <option value="11" <%= mesSelecionado === '11' ? 'selected' : '' %>>Novembro</option>
          <option value="12" <%= mesSelecionado === '12' ? 'selected' : '' %>>Dezembro</option>
        </select>
      </div>      <div class="filter-item">
        <label for="ordenacao">üîÄ Ordenar por</label>
        <select id="ordenacao" onchange="updateEstats()" class="filter-select">
          <option value="mediaPontos" <%= ordenacaoSelecionada === 'mediaPontos' ? 'selected' : '' %>>M√©dia de Pontos/Jogo</option>
          <option value="pontos" <%= ordenacaoSelecionada === 'pontos' ? 'selected' : '' %>>Pontos</option>
          <option value="percentagem" <%= ordenacaoSelecionada === 'percentagem' ? 'selected' : '' %>>% de Vit√≥rias</option>
        </select>
      </div>
    </div><!-- Curiosidades/Observa√ß√µes -->
    <% if (curiosidades && curiosidades.length > 0) { %>
      <div class="curiosidades-section">
        <h3 class="curiosidades-title">üîç Curiosidades & Observa√ß√µes</h3>
        <div class="curiosidades-grid-3col">
          <% curiosidades.forEach(curiosidade => { %>
            <div class="curiosidade-card-compact">
              <span class="curiosidade-icon-large"><%= curiosidade.icone %></span>
              <h4 class="curiosidade-titulo-compact"><%= curiosidade.titulo %></h4>
              <p class="curiosidade-texto-compact"><%= curiosidade.texto %></p>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>    <!-- An√°lise de Duplas -->
    <% var duplasSafe = typeof duplas !== 'undefined' && duplas ? duplas : { melhorVitorias: [], piorVitorias: [], maisJogos: [], menosJogos: [] }; %>
    <% if (duplasSafe.melhorVitorias && duplasSafe.melhorVitorias.length > 0) { %>      <div class="duplas-section-compact">
        <h3 class="duplas-title">üë• An√°lise de Duplas</h3>
        <p class="duplas-subtitle-small">
          <em>Melhores e piores duplas (m√≠nimo de 3 jogos juntos).<br>
          Duplas com mais e menos jogos (m√≠n. 25% de jogos realizados individualmente).</em>
        </p>
        
        <!-- TOP 3 - Melhor % Vit√≥rias -->
        <div class="dupla-categoria-compact">
          <h4 class="dupla-header-compact">
            üèÜ TOP 3 - Melhores Duplas
          </h4>
          <div class="duplas-compact-grid">
            <% duplasSafe.melhorVitorias.forEach((dupla, idx) => { %>
              <div class="dupla-card-mini <%= idx === 0 ? 'gold' : idx === 1 ? 'silver' : 'bronze' %>">
                <div class="dupla-rank">#<%= idx + 1 %></div>
                <div class="dupla-names"><%= dupla.jogador1 %> & <%= dupla.jogador2 %></div>
                <div class="dupla-stat-main"><strong><%= dupla.percentagem_vitorias %>%</strong> vit√≥rias</div>
                <div class="dupla-stats-mini">
                  <span><%= dupla.vitorias %>V</span> ¬∑ 
                  <span><%= dupla.empates || 0 %>E</span> ¬∑ 
                  <span><%= dupla.derrotas || 0 %>D</span> ¬∑ 
                  <span><%= dupla.jogos_juntos %>J</span>
                </div>
              </div>
            <% }) %>
          </div>        </div>

        <!-- TOP 3 - Pior % Vit√≥rias -->
        <div class="dupla-categoria-compact">
          <h4 class="dupla-header-compact">
            üí© TOP 3 - Piores Duplas
          </h4>
          <div class="duplas-compact-grid">
            <% duplasSafe.piorVitorias.forEach((dupla, idx) => { %>
              <div class="dupla-card-mini worst">
                <div class="dupla-rank">#<%= idx + 1 %></div>
                <div class="dupla-names"><%= dupla.jogador1 %> & <%= dupla.jogador2 %></div>
                <div class="dupla-stat-main"><strong><%= dupla.percentagem_vitorias %>%</strong> vit√≥rias</div>
                <div class="dupla-stats-mini">
                  <span><%= dupla.vitorias %>V</span> ¬∑ 
                  <span><%= dupla.empates || 0 %>E</span> ¬∑ 
                  <span><%= dupla.derrotas || 0 %>D</span> ¬∑ 
                  <span><%= dupla.jogos_juntos %>J</span>
                </div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- TOP 3 - Mais Jogos Juntos -->
        <div class="dupla-categoria-compact">
          <h4 class="dupla-header-compact">
            üî• TOP 3 - Duplas com Mais Jogos Juntos
          </h4>
          <div class="duplas-compact-grid">
            <% duplasSafe.maisJogos.forEach((dupla, idx) => { %>
              <div class="dupla-card-mini veteran">
                <div class="dupla-rank">#<%= idx + 1 %></div>
                <div class="dupla-names"><%= dupla.jogador1 %> & <%= dupla.jogador2 %></div>
                <div class="dupla-stat-main"><strong><%= dupla.jogos_juntos %></strong> jogos juntos</div>
                <div class="dupla-stats-mini">
                  <span><%= dupla.vitorias %>V</span> ¬∑ 
                  <span><%= dupla.empates || 0 %>E</span> ¬∑ 
                  <span><%= dupla.derrotas || 0 %>D</span> ¬∑ 
                  <span><%= dupla.percentagem_vitorias %>%</span>
                </div>
              </div>
            <% }) %>
          </div>
        </div>        <!-- TOP 3 - Menos Jogos Juntos -->
        <div class="dupla-categoria-compact">
          <h4 class="dupla-header-compact">
            üÜï TOP 3 - Duplas com Menos Jogos Juntos
          </h4>
          <div class="duplas-compact-grid">
            <% duplasSafe.menosJogos.forEach((dupla, idx) => { %>
              <div class="dupla-card-mini new">
                <div class="dupla-rank">#<%= idx + 1 %></div>
                <div class="dupla-names"><%= dupla.jogador1 %> & <%= dupla.jogador2 %></div>
                <div class="dupla-stat-main"><strong><%= dupla.jogos_juntos %></strong> jogos juntos</div>
                <div class="dupla-stats-mini">
                  <span><%= dupla.vitorias %>V</span> ¬∑ 
                  <span><%= dupla.empates || 0 %>E</span> ¬∑ 
                  <span><%= dupla.derrotas || 0 %>D</span> ¬∑ 
                  <span><%= dupla.percentagem_vitorias %>%</span>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
    <% } %>

    <!-- MVP Mensal -->
    <% if (mesSelecionado && mvpMensais && mvpMensais.length > 0) { %>
      <div class="mvp-section">
        <h3 class="mvp-title">üèÜ MVP<%= mvpMensais.length > 1 ? 's' : '' %> do M√™s</h3>
        <% if (mvpMensais.length > 1) { %>
          <p class="mvp-empate"><em>Empate no MVP! <%= mvpMensais.length %> jogadores empatados com <%= mvpMensais[0].pontos %> pontos</em></p>
        <% } %>
        <div class="mvp-cards">
          <% mvpMensais.forEach(mvp => { %>
            <div class="mvp-card">
              <div class="mvp-info">
                <h4><%= mvp.nome %></h4>
                <p><strong><%= mvp.pontos %> pontos</strong> | <%= mvp.jogos %>/<%= totalJogosMes %> jogos (<%= Math.round((mvp.jogos/totalJogosMes)*100) %>%)</p>
                <p><%= mvp.vitorias %>V <%= mvp.empates %>E <%= mvp.derrotas %>D | +<%= mvp.diferenca_golos %> diferen√ßa de golos</p>
              </div>
            </div>
          <% }) %>
        </div>        <p class="mvp-criteria"><em>Crit√©rio: M√≠nimo <%= minimoJogosParaMVP %> jogos (75% dos jogos do m√™s)</em></p>
      </div>
    <% } else if (mesSelecionado && totalJogosMes > 0 && (!mvpMensais || mvpMensais.length === 0)) { %>
      <div class="mvp-section">
        <div class="alert alert-warning">
          <h3>‚ö†Ô∏è MVP do M√™s</h3>
          <p>Nenhum jogador qualificado para MVP (m√≠nimo <%= minimoJogosParaMVP %> jogos de <%= totalJogosMes %> total)</p>
        </div>
      </div>
    <% } %><!-- Crit√©rios de Classifica√ß√£o -->
    <div class="classification-criteria">
      <h4>üìã Crit√©rios de Classifica√ß√£o <span style="color: #f9b233;">(Ordena√ß√£o atual: <%= ordenacaoSelecionada === 'percentagem' ? '% de Vit√≥rias' : ordenacaoSelecionada === 'mediaPontos' ? 'M√©dia de Pontos/Jogo' : 'Pontos' %>)</span></h4>
      <% if (ordenacaoSelecionada === 'percentagem') { %>
        <ol>
          <li><strong>% de Vit√≥rias</strong> (crit√©rio principal)</li>
          <li><strong>Diferen√ßa de golos</strong> (em caso de empate de %)</li>
          <li><strong>Golos marcados</strong> (em caso de empate de diferen√ßa)</li>
          <li><strong>N√∫mero de presen√ßas</strong> (em caso de empate de golos)</li>
        </ol>
      <% } else if (ordenacaoSelecionada === 'mediaPontos') { %>
        <ol>
          <li><strong>M√©dia de Pontos/Jogo (MP):</strong> Pontos totais √∑ Jogos (Vit√≥ria = 3pts, Empate = 1pt, Derrota = 0pts)</li>
          <li><strong>Diferen√ßa de golos</strong> (em caso de empate de m√©dia)</li>
          <li><strong>Golos marcados</strong> (em caso de empate de diferen√ßa)</li>
          <li><strong>N√∫mero de presen√ßas</strong> (em caso de empate de golos)</li>
        </ol>
      <% } else { %>
        <ol>
          <li><strong>Pontos:</strong> Vit√≥ria = 3pts, Empate = 1pt, Derrota = 0pts</li>
          <li><strong>Diferen√ßa de golos</strong> (em caso de empate de pontos)</li>
          <li><strong>Golos marcados</strong> (em caso de empate de diferen√ßa)</li>
          <li><strong>N√∫mero de presen√ßas</strong> (em caso de empate de golos)</li>
        </ol>
      <% } %>
      <% if (mesSelecionado) { %>
        <p><strong>MVP Mensal:</strong> Jogador(es) com mais pontos tendo participado em pelo menos 75% dos jogos do m√™s</p>
      <% } %>
    </div><table class="stats-table">
      <thead>
        <tr>
          <th>Pos</th>
          <th>Jogador</th>
          <th>MP</th>
          <th>Pontos</th>
          <th>Jogos</th>
          <th>Vit√≥rias</th>
          <th>Empates</th>
          <th>Derrotas</th>
          <th>% Vit√≥rias</th>
          <th>Golos Marcados</th>
          <th>Golos Sofridos</th>
          <th>Diferen√ßa</th>
        </tr>
      </thead>      <tbody>
        <% if (estatisticas && estatisticas.length > 0) { %>
          <% estatisticas.forEach((stat, index) => { %>            <tr class="<%= mvpMensais && mvpMensais.some(mvp => mvp.id === stat.id) ? 'mvp-row' : '' %> <%= !stat.temMinimoJogos ? 'sem-minimo-jogos' : '' %>">
              <td class="position"><%= index + 1 %>¬∫</td>
              <td class="player-name">
                <%= stat.nome %>
                <% if (mvpMensais && mvpMensais.some(mvp => mvp.id === stat.id)) { %>
                  <span class="mvp-badge">üèÜ MVP</span>
                <% } %>
              </td>
              <td class="stat-media-pontos"><strong><%= stat.media_pontos.toFixed(2) %></strong></td>
              <td class="stat-points"><strong><%= stat.pontos %></strong></td>
              <td><%= stat.jogos %></td>
              <td class="stat-wins"><%= stat.vitorias %></td>
              <td class="stat-draws"><%= stat.empates %></td>
              <td class="stat-losses"><%= stat.derrotas %></td>
              <td class="stat-percentage"><%= stat.percentagem_vitorias %>%</td>
              <td class="stat-goals-for"><%= stat.golos_marcados %></td>
              <td class="stat-goals-against"><%= stat.golos_sofridos %></td>
              <td class="stat-goal-diff <%= stat.diferenca_golos >= 0 ? 'positive' : 'negative' %>">
                <%= stat.diferenca_golos >= 0 ? '+' : '' %><%= stat.diferenca_golos %>
              </td>
            </tr>
          <% }) %>        <% } else { %>
          <tr>
            <td colspan="12" style="text-align: center;">Nenhuma estat√≠stica encontrada para o per√≠odo selecionado</td>
          </tr>
        <% } %>
      </tbody>
    </table>

    <% if (totalJogos && minimoJogos) { %>
      <div class="nota-minimo-jogos">
        ‚ÑπÔ∏è <strong>Nota:</strong> Para aparecer na classifica√ß√£o principal, os jogadores precisam ter participado em pelo menos <strong><%= minimoJogos %> jogos</strong> (25% de <%= totalJogos %> jogos totais). Jogadores com menos jogos aparecem no fundo da tabela com fundo cinzento.
      </div>
    <% } %>
  </main>
  <script>
  function updateEstats() {
    const ano = document.getElementById('ano').value;
    const mes = document.getElementById('mes').value;
    const ordenacao = document.getElementById('ordenacao').value;
    const url = `/estatisticas?ano=${ano}${mes ? '&mes=' + mes : ''}${ordenacao ? '&ordenacao=' + ordenacao : ''}`;
    window.location.href = url;
  }
  </script>
</body>
</html>