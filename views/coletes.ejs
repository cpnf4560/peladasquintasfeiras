<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <title>Gest√£o de Coletes - Peladas das Quintas Feiras</title>
  <link rel="stylesheet" href="/style.css?v=20250101">
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="shortcut icon" href="/logo.svg">
</head>
<body class="main-bg">  <%- include('partials/header', { user: user }) %>
  <main class="container">    <div class="coletes-header-modern">
      <h2 class="section-title">üü¢üî¥ Gest√£o de Coletes</h2>
      <p class="section-subtitle">Controlo de quem leva os coletes</p>
    </div>    <!-- Nota informativa -->
    <div class="info-note-modern">
      <span class="info-icon">‚ÑπÔ∏è</span>
      <p><strong>Nota:</strong> Registos desde outubro de 2025, a ordem n√£o est√° de acordo com o WhatsApp</p>
    </div><!-- Estado actual dos coletes --><div class="coletes-status-modern">
      <% if (coletesActuais) { %>
        <div class="status-card current-holder">
          <div class="status-icon">üëï</div>
          <div class="status-content">
            <h3>Coletes actualmente com:</h3>
            <p class="holder-name"><%= coletesActuais.jogador_nome %></p>
            <p class="holder-date">üìÖ Desde: <%= new Date(coletesActuais.data_levou).toLocaleDateString('pt-PT') %></p>
            
            <% if (user && user.role === 'admin') { %>
              <!-- Bot√£o para confirmar devolu√ß√£o -->
              <div style="margin-top: 20px;">
                <button type="button" class="btn btn-success" onclick="document.getElementById('formDevolucao').style.display='block'; this.style.display='none';">
                  ‚úÖ Confirmar Devolu√ß√£o
                </button>
              </div>
              
              <!-- Formul√°rio de devolu√ß√£o (inicialmente escondido) -->
              <div id="formDevolucao" style="display:none; margin-top: 20px; padding: 15px; background-color: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                <h4 style="margin-top: 0; color: #1e40af;">üë§ Quem levou os coletes?</h4>
                <form method="POST" action="/coletes/confirmar">
                  <div style="margin-bottom: 15px;">
                    <label for="jogador_select" style="display: block; margin-bottom: 5px; font-weight: bold;">
                      Selecionar jogador:
                    </label>
                    <select name="jogador_id" id="jogador_select" required 
                            style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #cbd5e1; font-size: 16px;">
                      <% if (proximoConvocado) { %>
                        <option value="<%= proximoConvocado.id %>" selected>
                          üéØ <%= proximoConvocado.nome %> (Sugest√£o: pr√≥ximo da lista)
                        </option>
                      <% } %>
                      <% 
                        const convocados = estatisticas.filter(j => j.tipo === 'convocado');
                        convocados.forEach(jogador => { 
                          if (!proximoConvocado || jogador.id !== proximoConvocado.id) { 
                      %>
                        <option value="<%= jogador.id %>">
                          <%= jogador.nome %> (Levou <%= jogador.vezes_levou %>x)
                        </option>
                      <% 
                          }
                        }); 
                      %>
                    </select>
                  </div>
                  
                  <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                      üíæ Confirmar
                    </button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" 
                            onclick="document.getElementById('formDevolucao').style.display='none'; document.querySelector('.btn-success').style.display='inline-block';">
                      ‚ùå Cancelar
                    </button>
                  </div>
                </form>
              </div>
            <% } %>
          </div>
        </div>
      <% } else { %>
        <div class="status-card available">
          <div class="status-icon">‚úÖ</div>
          <div class="status-content">
            <h3>Coletes Dispon√≠veis</h3>
            <p>Ningu√©m tem os coletes neste momento</p>
          </div>
        </div>
      <% } %>
      
      <!-- Informa√ß√£o do pr√≥ximo convocado -->
      <% if (proximoConvocado) { %>
        <div class="alert alert-success" style="margin-top: 15px;">
          <h3>üéØ Pr√≥ximo a levar os coletes:</h3>
          <p><strong><%= proximoConvocado.nome %></strong></p>
          <p>
            Vezes que j√° levou: <strong><%= proximoConvocado.vezes_levou %></strong>
            <% if (proximoConvocado.ultima_vez) { %>
              | √öltima vez: <%= new Date(proximoConvocado.ultima_vez).toLocaleDateString('pt-PT') %>
            <% } else { %>
              | <em>Nunca levou os coletes</em>
            <% } %>          </p>
          <% if (user && user.role === 'admin') { %>
            <% if (!coletesActuais) { %>
            <form method="POST" action="/coletes/atribuir" style="margin-top: 10px;">
              <input type="hidden" name="jogador_id" value="<%= proximoConvocado.id %>">
              <button type="submit" class="btn btn-primary">
                üì• Atribuir Coletes a <%= proximoConvocado.nome %>
              </button>
            </form>
            <% } %>
          <% } %>
        </div>
      <% } %>
    </div>    <!-- Tabela de estat√≠sticas -->
    <div class="coletes-stats card-visual">
      <h3>üìä Estat√≠sticas dos Convocados</h3>
      <p><em>Apenas os 10 convocados podem levar os coletes</em></p>
      <% if (estatisticas.length > 0) { %>
        <% 
          const convocados = estatisticas.filter(j => j.tipo === 'convocado');
          const reservas = estatisticas.filter(j => j.tipo === 'reserva');
        %>
        <table class="table stats-table">
          <thead>
            <tr>
              <th>Posi√ß√£o</th>
              <th>Jogador</th>
              <th>Posi√ß√£o Convocat√≥ria</th>
              <th>Vezes que Levou</th>
              <th>√öltima Vez</th>
              <th>Prioridade</th>
              <th>Ac√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            <% convocados.forEach((jogador, index) => { %>
              <tr class="<%= index < 3 ? 'priority-high' : '' %> <%= index % 2 === 0 ? 'zebra' : '' %>">
                <td><%= index + 1 %>¬∫</td>
                <td><%= jogador.nome %></td>
                <td><%= jogador.posicao %>¬∫ Convocado</td>
                <td><%= jogador.vezes_levou %></td>
                <td>
                  <% if (jogador.ultima_vez) { %>
                    <%= new Date(jogador.ultima_vez).toLocaleDateString('pt-PT') %>
                  <% } else { %>
                    <em>Nunca</em>
                  <% } %>
                </td>
                <td>
                  <% if (index === 0) { %>
                    <span class="priority-badge high">üî• ALTA</span>
                  <% } else if (index < 3) { %>
                    <span class="priority-badge medium">‚ö° M√âDIA</span>
                  <% } else { %>
                    <span class="priority-badge low">üí§ BAIXA</span>
                  <% } %>                </td>
                <td>
                  <% if (user && user.role === 'admin') { %>
                    <% if (!coletesActuais) { %>
                    <form method="POST" action="/coletes/atribuir" style="display: inline;">
                      <input type="hidden" name="jogador_id" value="<%= jogador.id %>">
                      <button type="submit" class="btn btn-primary btn-sm">
                        üì• Atribuir Coletes
                      </button>
                    </form>
                    <% } %>
                  <% } %>
                </td>
              </tr>
            <% }) %>
            <% if (reservas.length > 0) { %>
              <% reservas.forEach((jogador, index) => { %>
                <tr class="jogador-reserva">
                  <td>-</td>
                  <td><%= jogador.nome %></td>
                  <td><%= jogador.posicao %>¬∫ Reserva</td>
                  <td><%= jogador.vezes_levou %></td>
                  <td>
                    <% if (jogador.ultima_vez) { %>
                      <%= new Date(jogador.ultima_vez).toLocaleDateString('pt-PT') %>
                    <% } else { %>
                      <em>Nunca</em>
                    <% } %>
                  </td>
                  <td>
                    <span class="priority-badge none">-</span>
                  </td>
                  <td>-</td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      <% } else { %>
        <p>Nenhum jogador dispon√≠vel.</p>
      <% } %>
    </div>

    <!-- Sugest√£o autom√°tica -->
    <% if (!coletesActuais && estatisticas.length > 0) { %>
      <div class="suggestion">
        <h3>üí° Sugest√£o Autom√°tica</h3>
        <p>Pr√≥ximo jogador sugerido: <strong><%= estatisticas[0].nome %></strong></p>
        <p>
          <% if (estatisticas[0].vezes_levou === 0) { %>
            (Nunca levou os coletes)
          <% } else { %>
            (Levou <%= estatisticas[0].vezes_levou %> vez<%= estatisticas[0].vezes_levou > 1 ? 'es' : '' %>)
          <% } %>        </p>
        
        <% if (user && user.role === 'admin') { %>
        <form method="POST" action="/coletes/atribuir">
          <input type="hidden" name="jogador_id" value="<%= estatisticas[0].id %>">
          <button type="submit" class="btn btn-primary btn-large">
            üéØ Atribuir ao Pr√≥ximo da Lista
          </button>
        </form>
        <% } %>
      </div><% } %>
  </main>

  <%- include('partials/footer') %>
</body>
</html>
