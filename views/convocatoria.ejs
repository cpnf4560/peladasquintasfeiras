<!DOCTYPE html>
<html>
<head>  <title>Convocat√≥ria - Peladas das Quintas Feiras</title>
  <link rel="stylesheet" href="/style.css?v=20250101">
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link rel="shortcut icon" href="/logo.svg">
</head>
<body class="main-bg">  
<%- include('partials/header', { user: user }) %>
  <main class="container">    <!-- Mensagem de sucesso -->
    <% if (typeof msg !== 'undefined' && msg === 'faltas_limpas') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">‚úÖ</span>
        <div>
          <strong style="font-size: 1.1rem;">Faltas Limpas com Sucesso!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">Todos os jogadores agora t√™m 0 faltas.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'equipas_salvas') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">üíæ</span>
        <div>
          <strong style="font-size: 1.1rem;">Equipas Salvas com Sucesso!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">As equipas foram guardadas e est√£o prontas para o pr√≥ximo jogo.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'indisponivel_adicionado') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">‚è∏Ô∏è</span>
        <div>
          <strong style="font-size: 1.1rem;">Jogador Adicionado aos Indispon√≠veis!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">O jogador n√£o receber√° faltas durante o per√≠odo de aus√™ncia.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'indisponivel_removido') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">üîô</span>
        <div>
          <strong style="font-size: 1.1rem;">Jogador Reativado!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">O jogador retornou √† sua posi√ß√£o original na convocat√≥ria.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'jogos_decrementados') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">‚è¨</span>
        <div>
          <strong style="font-size: 1.1rem;">Jogos Decrementados!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">Per√≠odo de aus√™ncia atualizado para todos os indispon√≠veis.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'jogador_movido_reservas') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">‚¨áÔ∏è</span>
        <div>
          <strong style="font-size: 1.1rem;">Jogador Movido para Reservas!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">Jogador foi movido para reservas sem receber falta. Pr√≥ximo reserva foi promovido.</p>
        </div>
      </div>
    <% } %>
    
    <% if (typeof msg !== 'undefined' && msg === 'jogador_movido_convocados') { %>
      <div class="success-message" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); display: flex; align-items: center; gap: 1rem;">
        <span style="font-size: 2rem;">‚¨ÜÔ∏è</span>
        <div>
          <strong style="font-size: 1.1rem;">Jogador Promovido para Convocados!</strong>
          <p style="margin: 0.25rem 0 0 0; opacity: 0.95; font-size: 0.95rem;">Reserva foi promovido para a lista de convocados.</p>
        </div>
      </div>
    <% } %>
      
      <div class="convocatoria-header-modern">
      <div class="header-content">
        <h2 class="section-title">üìã Convocat√≥ria</h2>
        <p class="section-subtitle">Gest√£o de convocados e reservas</p>
        <div class="info-badge-modern">
          <span class="badge-icon">üìÖ</span>
          <span class="badge-text">Em vigor desde 21/10/2025</span>
        </div>
      </div>
      <% if (user && user.role === 'admin') { %>
      <div class="convocatoria-actions-modern">
        <% if (convocados.length > 10) { %>
          <form method="POST" action="/convocatoria/migrar-para-10" style="display: inline;" 
                onsubmit="return confirm('Migrar para 10 convocados? Os √∫ltimos 4 convocados ser√£o movidos para reservas.')">
            <button type="submit" class="btn-action-modern btn-warning">
              ‚ö° Migrar para 10
            </button>
          </form>
        <% } %>        <form method="POST" action="/convocatoria/limpar-todas-faltas" style="display: inline;" 
              onsubmit="return confirm('‚ö†Ô∏è Limpar TODAS as faltas de TODOS os jogadores? Esta a√ß√£o n√£o pode ser desfeita.')">
          <button type="submit" class="btn-action-modern btn-danger" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
            üßπ Limpar Faltas
          </button>
        </form>
        <form method="POST" action="/convocatoria/configuracao-final" style="display: inline;" 
              onsubmit="return confirm('Aplicar configura√ß√£o final? Isto ir√° limpar as faltas de teste e definir a ordem espec√≠fica dos jogadores.')">
          <button type="submit" class="btn-action-modern btn-success-modern">
            ‚úÖ Config Final
          </button>
        </form>
        <form method="POST" action="/convocatoria/reset" style="display: inline;" 
              onsubmit="return confirm('Tem certeza que deseja resetar a convocat√≥ria?')">
          <button type="submit" class="btn-action-modern btn-secondary-modern">
            üîÑ Resetar
          </button>
        </form>
      </div>
      <% } %>
    </div>    <div class="info-card-modern">
      <h3 class="info-title">‚ÑπÔ∏è Como Funciona</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-icon">üèÜ</span>
          <div>
            <strong>Convocados</strong>
            <p><%= config.max_convocados || 10 %> jogadores principais</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">‚è≥</span>
          <div>
            <strong>Reservas</strong>
            <p>Lista de espera autom√°tica</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">‚è∏Ô∏è</span>
          <div>
            <strong>Indispon√≠veis</strong>
            <p>Aus√™ncias tempor√°rias sem faltas</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">üö´</span>
          <div>
            <strong>Falta</strong>
            <p>Desce para fim das reservas</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">‚¨ÜÔ∏è</span>
          <div>
            <strong>Promo√ß√£o</strong>
            <p>1¬∫ reserva sobe automaticamente</p>
          </div>
        </div>
        <div class="info-item">
          <span class="info-icon">üîô</span>
          <div>
            <strong>Retorno</strong>
            <p>Volta √† posi√ß√£o original</p>
          </div>
        </div>
      </div>
    </div><div class="convocatoria-grid-modern">
      <!-- Tabela de Convocados -->
      <div class="convocados-card">
        <div class="card-header-modern convocados-header">
          <h3 class="card-title-modern">üèÜ Convocados</h3>
          <span class="count-badge convocados-badge"><%= convocados.length %>/<%= config.max_convocados || 10 %></span>
        </div>
        <div class="table-wrapper-modern">          <table class="table-modern convocados-table">
            <thead>
              <tr>
                <th style="width: 45px;">#</th>
                <th style="width: 35%;">Nome</th>
                <th style="width: 60px;">Faltas</th>
                <th style="width: 25%;">Status</th>
                <th style="width: 100px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <% if (convocados && convocados.length > 0) { %>                <% convocados.forEach((jogador, index) => { %>
                  <tr class="table-row-modern <%= jogador.confirmado ? 'confirmed-row' : '' %>">
                    <td class="position-cell"><strong>#<%= jogador.posicao %></strong></td>
                    <td class="player-cell">
                      <span class="player-name-badge">
                        <%= jogador.confirmado ? '‚úÖ' : 'üü°' %> <%= jogador.nome %>
                      </span>
                    </td>
                    <td class="faltas-cell">
                      <span class="badge-faltas-modern <%= jogador.total_faltas > 2 ? 'high-faltas' : '' %>">
                        üö´ <%= jogador.total_faltas || 0 %>
                      </span>
                    </td>
                    <td class="status-cell">
                      <% if (jogador.confirmado) { %>
                        <div class="status-confirmed">
                          <span class="status-label">‚úÖ Confirmado</span>
                          <% if (jogador.data_confirmacao) { %>
                            <small class="status-date">
                              <%= new Date(jogador.data_confirmacao).toLocaleDateString('pt-PT', {day: '2-digit', month: '2-digit'}) %> 
                              <%= new Date(jogador.data_confirmacao).toLocaleTimeString('pt-PT', {hour: '2-digit', minute: '2-digit'}) %>
                            </small>
                          <% } %>
                        </div>
                      <% } else { %>
                        <span class="status-pending">‚è≥ Pendente</span>
                      <% } %>                    </td>                    <td class="actions-cell">                      <% if (user && user.role === 'admin') { %>
                      <div class="action-buttons-modern">
                        <form method="POST" action="/convocatoria/confirmar-presenca/<%= jogador.id %>" style="display: inline;">
                          <button type="submit" class="btn-mini <%= jogador.confirmado ? 'btn-mini-danger' : 'btn-mini-success' %>" 
                                  title="<%= jogador.confirmado ? 'Desconfirmar' : 'Confirmar' %>">
                            <%= jogador.confirmado ? '‚úñÔ∏è' : '‚úîÔ∏è' %>
                          </button>
                        </form>
                        <form method="POST" action="/convocatoria/mover-para-reservas/<%= jogador.id %>" 
                              style="display: inline;" 
                              onsubmit="return confirm('Mover <%= jogador.nome %> para reservas (sem falta)?')">
                          <button type="submit" class="btn-mini btn-mini-info" title="Mover para Reservas">
                            ‚¨áÔ∏è
                          </button>
                        </form>
                        <form method="POST" action="/convocatoria/marcar-falta/<%= jogador.id %>" 
                              style="display: inline;" 
                              onsubmit="return confirm('Marcar <%= jogador.nome %> como faltoso?')">
                          <button type="submit" class="btn-mini btn-mini-warning" title="Marcar Falta">
                            üö´
                          </button>
                        </form>
                      </div>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="5" class="empty-row">
                    <span class="empty-icon">üë•</span>
                    <p>Nenhum jogador convocado</p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabela de Reservas -->
      <div class="reservas-card">
        <div class="card-header-modern reservas-header">
          <h3 class="card-title-modern">‚è≥ Reservas</h3>
          <span class="count-badge reservas-badge"><%= reservas.length %></span>
        </div>
        <div class="table-wrapper-modern">          <table class="table-modern reservas-table">            <thead>
              <tr>
                <th style="width: 45px;">#</th>
                <th style="width: 28%;">Nome</th>
                <th style="width: 60px;">Faltas</th>
                <th style="width: 70px;">Reordenar</th>
                <th style="width: 22%;">Status</th>
                <% if (user && user.role === 'admin') { %>
                <th style="width: 60px;">A√ß√µes</th>
                <% } %>
              </tr>
            </thead>
            <tbody>              <% if (reservas && reservas.length > 0) { %>
                <% reservas.forEach((jogador, index) => { %>
                  <tr class="table-row-modern <%= index === 0 ? 'next-player-row' : '' %>">
                    <td class="position-cell"><strong>#<%= jogador.posicao %></strong></td>
                    <td class="player-cell">
                      <span class="player-name-badge <%= index === 0 ? 'next-badge' : '' %>">
                        <%= index === 0 ? 'üî•' : '‚è≥' %> <%= jogador.nome %>
                      </span>
                      <% if (index === 0) { %>
                        <span class="next-indicator">‚Üê Pr√≥ximo</span>
                      <% } %>
                    </td>
                    <td class="faltas-cell">
                      <span class="badge-faltas-modern <%= jogador.total_faltas > 2 ? 'high-faltas' : '' %>">
                        üö´ <%= jogador.total_faltas || 0 %>
                      </span>                    </td>
                    <td class="reorder-cell">
                      <% if (user && user.role === 'admin') { %>
                      <div class="reorder-buttons">
                        <% if (jogador.posicao > 1) { %>
                          <form method="POST" action="/convocatoria/mover-reserva/<%= jogador.id %>/up" style="display: inline;">
                            <button type="submit" class="btn-arrow btn-arrow-up" title="Mover para cima">‚ñ≤</button>
                          </form>
                        <% } %>
                        <% if (index < reservas.length - 1) { %>
                          <form method="POST" action="/convocatoria/mover-reserva/<%= jogador.id %>/down" style="display: inline;">
                            <button type="submit" class="btn-arrow btn-arrow-down" title="Mover para baixo">‚ñº</button>
                          </form>
                        <% } %>
                      </div>
                      <% } %>
                    </td>                    <td class="status-cell">
                      <span class="badge-status-modern <%= index === 0 ? 'badge-next' : 'badge-waiting' %>">
                        <%= index === 0 ? '‚≠ê Pr√≥ximo' : '‚è≥ Reserva' %>
                      </span>
                    </td>                    <% if (user && user.role === 'admin') { %>
                    <td class="actions-cell">
                      <form method="POST" action="/convocatoria/mover-para-convocados/<%= jogador.id %>" 
                            style="display: inline;" 
                            onsubmit="return confirm('Promover <%= jogador.nome %> para convocados?')">
                        <button type="submit" class="btn-mini btn-mini-success" title="Mover para Convocados">
                          ‚¨ÜÔ∏è
                        </button>
                      </form>
                    </td>
                    <% } %>
                  </tr>                <% }) %>              <% } else { %>
                <tr>
                  <td colspan="<%= user && user.role === 'admin' ? '6' : '5' %>" class="empty-row">
                    <span class="empty-icon">‚è≥</span>
                    <p>Nenhuma reserva</p>
                  </td>
                </tr>
              <% } %></tbody>
          </table>
        </div>
      </div>

      <!-- Card de Indispon√≠veis Tempor√°rios -->
      <div class="indisponiveis-card">
        <div class="card-header-modern indisponiveis-header">
          <h3 class="card-title-modern">‚è∏Ô∏è Indispon√≠veis Tempor√°rios</h3>
          <span class="count-badge indisponiveis-badge"><%= indisponiveis.length %></span>
        </div>
        
        <% if (user && user.role === 'admin') { %>
        <div style="padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
          <button onclick="document.getElementById('modalIndisponivel').style.display='flex'" 
                  class="btn-action-modern btn-primary" 
                  style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
            ‚ûï Adicionar Indispon√≠vel
          </button>
        </div>
        <% } %>
        
        <div class="table-wrapper-modern">
          <table class="table-modern indisponiveis-table">
            <thead>
              <tr>
                <th>Jogador</th>
                <th>Motivo</th>
                <th>Per√≠odo</th>
                <th>Status</th>
                <% if (user && user.role === 'admin') { %>
                <th>A√ß√µes</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% if (indisponiveis && indisponiveis.length > 0) { %>
                <% indisponiveis.forEach((indisponivel) => { %>
                  <tr class="table-row-modern">
                    <td class="player-cell">
                      <span class="player-name-badge">‚è∏Ô∏è <%= indisponivel.nome %></span>
                    </td>
                    <td class="motivo-cell">
                      <span class="badge-motivo"><%= indisponivel.motivo %></span>
                    </td>
                    <td class="periodo-cell">
                      <% if (indisponivel.numero_jogos && indisponivel.numero_jogos > 0) { %>
                        <span class="badge-periodo badge-jogos">
                          üéØ <%= indisponivel.numero_jogos %> <%= indisponivel.numero_jogos === 1 ? 'jogo' : 'jogos' %>
                        </span>
                      <% } else if (indisponivel.data_fim) { %>
                        <span class="badge-periodo badge-data">
                          üìÖ At√© <%= new Date(indisponivel.data_fim).toLocaleDateString('pt-PT') %>
                        </span>
                      <% } else { %>
                        <span class="badge-periodo">‚è≥ Indefinido</span>
                      <% } %>
                    </td>
                    <td class="status-cell">
                      <span class="badge-status-modern badge-indisponivel">üö´ Indispon√≠vel</span>
                    </td>
                    <% if (user && user.role === 'admin') { %>
                    <td class="actions-cell">
                      <form method="POST" action="/convocatoria/remover-indisponivel/<%= indisponivel.id %>" 
                            style="display: inline;"
                            onsubmit="return confirm('Remover <%= indisponivel.nome %> dos indispon√≠veis? Ele retornar√° √† posi√ß√£o original.')">
                        <button type="submit" class="btn-mini btn-mini-success" title="Reativar">
                          üîô Reativar
                        </button>
                      </form>
                    </td>
                    <% } %>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="<%= user && user.role === 'admin' ? '5' : '4' %>" class="empty-row">
                    <span class="empty-icon">‚úÖ</span>
                    <p>Todos os jogadores dispon√≠veis</p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal para Adicionar Indispon√≠vel -->
    <% if (user && user.role === 'admin') { %>
    <div id="modalIndisponivel" class="modal-overlay" onclick="if(event.target === this) this.style.display='none'">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ûï Adicionar Jogador aos Indispon√≠veis</h3>
          <button class="modal-close" onclick="document.getElementById('modalIndisponivel').style.display='none'">‚úñ</button>
        </div>
        
        <form method="POST" action="/convocatoria/adicionar-indisponivel" class="modal-form">
          <div class="form-group">
            <label for="jogador_id">üéØ Jogador</label>
            <select id="jogador_id" name="jogador_id" required class="form-select">
              <option value="">Selecione um jogador...</option>
              <% [...convocados, ...reservas].forEach(jogador => { %>
                <option value="<%= jogador.id %>"><%= jogador.nome %> (<%= jogador.tipo === 'convocado' ? 'Convocado' : 'Reserva' %>)</option>
              <% }) %>
            </select>
          </div>
          
          <div class="form-group">
            <label for="tipo_periodo">‚è±Ô∏è Tipo de Per√≠odo</label>
            <select id="tipo_periodo" name="tipo_periodo" required class="form-select" onchange="togglePeriodoInputs()">
              <option value="jogos">Por n√∫mero de jogos</option>
              <option value="data">Por data espec√≠fica</option>
            </select>
          </div>
          
          <div class="form-group" id="campo_jogos">
            <label for="numero_jogos">üéØ N√∫mero de Jogos</label>
            <input type="number" id="numero_jogos" name="numero_jogos" min="1" max="50" placeholder="Ex: 3" class="form-input">
            <small class="form-hint">Quantos jogos o jogador estar√° ausente</small>
          </div>
          
          <div class="form-group" id="campo_data" style="display: none;">
            <label for="data_fim">üìÖ Data de Retorno</label>
            <input type="date" id="data_fim" name="data_fim" class="form-input">
            <small class="form-hint">Data em que o jogador retorna</small>
          </div>
          
          <div class="form-group">
            <label for="motivo">üìù Motivo</label>
            <textarea id="motivo" name="motivo" required rows="3" placeholder="Ex: Forma√ß√£o profissional, Les√£o, Viagem..." class="form-textarea"></textarea>
            <small class="form-hint">Descreva o motivo da aus√™ncia</small>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="document.getElementById('modalIndisponivel').style.display='none'">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              ‚úÖ Adicionar aos Indispon√≠veis
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <script>
      function togglePeriodoInputs() {
        const tipo = document.getElementById('tipo_periodo').value;
        const campoJogos = document.getElementById('campo_jogos');
        const campoData = document.getElementById('campo_data');
        const inputJogos = document.getElementById('numero_jogos');
        const inputData = document.getElementById('data_fim');
        
        if (tipo === 'jogos') {
          campoJogos.style.display = 'block';
          campoData.style.display = 'none';
          inputJogos.required = true;
          inputData.required = false;
        } else {
          campoJogos.style.display = 'none';
          campoData.style.display = 'block';
          inputJogos.required = false;
          inputData.required = true;
        }
      }
    </script>
    <% } %>
  </main>

    <div class="convocatoria-stats">
      <div class="stats-summary">
        <div class="stat-item">
          <span class="stat-number"><%= convocados.length %></span>
          <span class="stat-label">Convocados</span>
        </div>
        <div class="stat-item">
          <span class="stat-number"><%= reservas.length %></span>
          <span class="stat-label">Reservas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number"><%= convocados.length + reservas.length %></span>
          <span class="stat-label">Total Ativos</span>
        </div>
      </div>
    </div>    <!-- Bot√£o para confirmar convocados e gerar equipas -->
    <% if (user && user.role === 'admin') { %>
      <% if (convocados.length >= 10) { %>      <div class="confirmar-convocados-section">
        <h3>‚öΩ Formar Equipas</h3>
        <p>Com <strong><%= convocados.length %></strong> convocados confirmados, pode gerar automaticamente as equipas equilibradas.</p>
        <form method="POST" action="/convocatoria/confirmar-equipas" 
              onsubmit="return confirm('Gerar equipas equilibradas baseadas nas estat√≠sticas dos jogadores?')">
          <button type="submit" class="btn btn-success btn-large">
            üèÜ Confirmar Convocados & Gerar Equipas
          </button>
        </form>
      </div>
      <% } %>
    <% } %>

    <!-- Se√ß√£o de Equipas Equilibradas -->
    <% if (typeof equipas !== 'undefined' && equipas) { %>      <div class="equipas-section">        <h3>üèüÔ∏è Equipas Equilibradas</h3>
        <p class="equipas-info">Equipas geradas automaticamente baseadas na <strong>m√©dia de pontos</strong> dos jogadores para m√°ximo equil√≠brio.</p>
        
        <div class="equipas-container">          <div class="equipa-card equipa-verde card-visual">
            <div class="equipa-header">
              <h4>üü¢ Equipa 1 - Coletes Verdes</h4>
              <div class="equipa-stats">
                <span>M√©dia: <%= (parseFloat(equipas.equipa1.media_pontos) || 0).toFixed(2) %> pts/jogo</span>
                <span>Pontos Totais: <%= equipas.equipa1.pontos_totais %></span>
              </div>
            </div>
            <div class="jogadores-equipa">              <% equipas.equipa1.jogadores.forEach((jogador, index) => { %>                <div class="jogador-equipa-item" data-jogador-id="<%= jogador.id %>" data-equipa="1">
                  <span class="jogador-posicao"><%= index + 1 %>.</span>
                  <span class="jogador-nome"><%= jogador.nome %></span>
                  <span class="jogador-pontos"><%= (parseFloat(jogador.media_pontos) || 0).toFixed(2) %> pts</span>
                  <% if (user && user.role === 'admin') { %>
                  <button class="btn-trocar" onclick="prepararTroca('<%= jogador.id %>', 1)">üîÑ</button>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>          <div class="equipa-card equipa-vermelha card-visual">
            <div class="equipa-header">
              <h4>üî¥ Equipa 2 - Coletes Vermelhos</h4>
              <div class="equipa-stats">
                <span>M√©dia: <%= (parseFloat(equipas.equipa2.media_pontos) || 0).toFixed(2) %> pts/jogo</span>
                <span>Pontos Totais: <%= equipas.equipa2.pontos_totais %></span>
              </div>
            </div>
            <div class="jogadores-equipa">              <% equipas.equipa2.jogadores.forEach((jogador, index) => { %>
                <div class="jogador-equipa-item" data-jogador-id="<%= jogador.id %>" data-equipa="2">
                  <span class="jogador-posicao"><%= index + 1 %>.</span>
                  <span class="jogador-nome"><%= jogador.nome %></span>
                  <span class="jogador-pontos"><%= (parseFloat(jogador.media_pontos) || 0).toFixed(2) %> pts</span>
                  <% if (user && user.role === 'admin') { %>
                  <button class="btn-trocar" onclick="prepararTroca('<%= jogador.id %>', 2)">üîÑ</button>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- Bot√µes de a√ß√£o para as equipas -->
        <div class="equipas-actions">
          <form method="POST" action="/convocatoria/reequilibrar-equipas" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
              üîÑ Reequilibrar Automaticamente
            </button>
          </form>
          <form method="POST" action="/convocatoria/salvar-equipas" style="display: inline;"
                onsubmit="return confirm('Salvar estas equipas para o pr√≥ximo jogo?')">
            <button type="submit" class="btn btn-primary">
              üíæ Salvar Equipas
            </button>
          </form>
        </div>
      </div>
    <% } %>
<%- include('partials/footer') %>
  <script>
    // Confirma√ß√£o para marcar falta
    function marcarFalta(jogadorId, nomeJogador) {
      if (confirm(`Tem certeza que deseja marcar ${nomeJogador} como faltoso?\n\nEle ser√° movido para o final das reservas e o primeiro reserva ser√° promovido.`)) {
        document.getElementById(`form-falta-${jogadorId}`).submit();
      }
    }

    // Funcionalidade de trocas entre equipas
    let jogadorSelecionado = null;
    
    function prepararTroca(jogadorId, equipaAtual) {
      if (jogadorSelecionado === null) {
        // Primeiro jogador selecionado
        jogadorSelecionado = { id: jogadorId, equipa: equipaAtual };
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.add('selecionado-para-troca');
        alert('Jogador selecionado! Agora clique no jogador da outra equipa para fazer a troca.');
      } else if (jogadorSelecionado.id === jogadorId) {
        // Cancelar sele√ß√£o
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = null;
        alert('Sele√ß√£o cancelada.');
      } else if (jogadorSelecionado.equipa === equipaAtual) {
        // Mesma equipa - cancelar e selecionar novo
        document.querySelector(`[data-jogador-id="${jogadorSelecionado.id}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = { id: jogadorId, equipa: equipaAtual };
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.add('selecionado-para-troca');
        alert('Novo jogador selecionado! Clique em um jogador da outra equipa para fazer a troca.');
      } else {
        // Fazer a troca
        if (confirm('Confirmar troca entre os jogadores selecionados?')) {
          trocarJogadores(jogadorSelecionado.id, jogadorId);
        }
        // Limpar sele√ß√£o
        document.querySelector(`[data-jogador-id="${jogadorSelecionado.id}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = null;
      }
    }
    
    function trocarJogadores(jogadorId1, jogadorId2) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/convocatoria/trocar-jogadores';
      
      const input1 = document.createElement('input');
      input1.type = 'hidden';
      input1.name = 'jogador1';
      input1.value = jogadorId1;
      
      const input2 = document.createElement('input');
      input2.type = 'hidden';
      input2.name = 'jogador2';
      input2.value = jogadorId2;
      
      form.appendChild(input1);
      form.appendChild(input2);
      document.body.appendChild(form);
      form.submit();
    }

    // Auto-refresh da p√°gina a cada 30 segundos para mostrar atualiza√ß√µes
    setTimeout(function() {
      location.reload();
    }, 30000);
  </script>
</body>
</html>
