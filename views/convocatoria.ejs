<!DOCTYPE html>
<html>
<head>
  <title>Convocat√≥ria - Peladas das Quintas Feiras</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
</head>
<body class="main-bg">
  <header class="header">
    <div class="logo-area">
      <img src="/logo.svg" alt="Logo" class="logo-image">
      <span class="logo-text">Peladas das Quintas Feiras</span>
    </div>
    <nav class="navbar">
      <a href="/" class="nav-link">Jogos</a>
      <a href="/jogadores" class="nav-link">Jogadores</a>
      <a href="/convocatoria" class="nav-link active">Convocat√≥ria</a>
      <a href="/coletes" class="nav-link">Coletes</a>
      <a href="/jogos/novo" class="nav-link">Novo Jogo</a>
      <a href="/estatisticas" class="nav-link">Estat√≠sticas</a>
    </nav>
  </header>

  <main class="container">
    <div class="convocatoria-header">
      <h2 class="section-title">Convocat√≥ria</h2>      <div class="convocatoria-actions">
        <% if (convocados.length > 10) { %>
          <form method="POST" action="/convocatoria/migrar-para-10" style="display: inline;" 
                onsubmit="return confirm('Migrar para 10 convocados? Os √∫ltimos 4 convocados ser√£o movidos para reservas.')">
            <button type="submit" class="btn btn-primary">
              ‚ö° Migrar para 10
            </button>
          </form>
        <% } %>
        <form method="POST" action="/convocatoria/configuracao-final" style="display: inline;" 
              onsubmit="return confirm('Aplicar configura√ß√£o final? Isto ir√° limpar as faltas de teste e definir a ordem espec√≠fica dos jogadores.')">
          <button type="submit" class="btn btn-success">
            ‚úÖ Configura√ß√£o Final
          </button>
        </form>
        <form method="POST" action="/convocatoria/reset" style="display: inline;" 
              onsubmit="return confirm('Tem certeza que deseja resetar a convocat√≥ria?')">
          <button type="submit" class="btn btn-secondary">
            üîÑ Resetar Convocat√≥ria
          </button>
        </form>
      </div>
    </div>

    <div class="convocatoria-info">
      <div class="info-card">        <h3>‚ÑπÔ∏è Como Funciona</h3>
        <ul>
          <li><strong>Convocados:</strong> <%= config.max_convocados || 10 %> jogadores principais</li>
          <li><strong>Reservas:</strong> Jogadores em lista de espera</li>
          <li><strong>Falta:</strong> Quando um convocado falta, vai para o final das reservas</li>
          <li><strong>Promo√ß√£o:</strong> O primeiro reserva sobe automaticamente para convocado</li>
          <li><strong>Reordenar:</strong> Use as setas para alterar a ordem das reservas</li>
        </ul>
      </div>
    </div>

    <div class="convocatoria-tables">      <!-- Tabela de Convocados -->
      <div class="convocados-section">
        <h3 class="table-title">üèÜ Convocados (<%= convocados.length %>/<%= config.max_convocados || 10 %>)</h3>
        <div class="table-container">
          <table class="convocatoria-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Faltas</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <% if (convocados && convocados.length > 0) { %>
                <% convocados.forEach((jogador, index) => { %>
                  <tr class="convocado-row">
                    <td class="posicao-number"><%= jogador.posicao %></td>
                    <td class="jogador-nome">
                      <span class="nome-convocado">üü¢ <%= jogador.nome %></span>
                    </td>
                    <td class="faltas-count">
                      <span class="badge-faltas"><%= jogador.total_faltas || 0 %></span>
                    </td>
                    <td class="acoes-convocado">
                      <form method="POST" action="/convocatoria/marcar-falta/<%= jogador.id %>" 
                            style="display: inline;" 
                            onsubmit="return confirm('Marcar <%= jogador.nome %> como faltoso?')">
                        <button type="submit" class="btn-small btn-falta">
                          ‚ùå Falta
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="no-data">Nenhum jogador convocado</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>      <!-- Tabela de Reservas -->
      <div class="reservas-section">
        <h3 class="table-title">‚è≥ Reservas (<%= reservas.length %>)</h3>
        <div class="table-container">
          <table class="convocatoria-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Faltas</th>
                <th>Reordenar</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% if (reservas && reservas.length > 0) { %>
                <% reservas.forEach((jogador, index) => { %>
                  <tr class="reserva-row <%= index === 0 ? 'proximo-convocado' : '' %>">
                    <td class="posicao-number"><%= jogador.posicao %></td>
                    <td class="jogador-nome">
                      <span class="nome-reserva">
                        <%= index === 0 ? 'üî•' : 'üü°' %> <%= jogador.nome %>
                      </span>
                    </td>
                    <td class="faltas-count">
                      <span class="badge-faltas"><%= jogador.total_faltas || 0 %></span>
                    </td>
                    <td class="reordenar-actions">
                      <% if (jogador.posicao > 1) { %>
                        <form method="POST" action="/convocatoria/mover-reserva/<%= jogador.id %>/up" style="display: inline;">
                          <button type="submit" class="btn-seta btn-up" title="Mover para cima">‚ñ≤</button>
                        </form>
                      <% } %>
                      <% if (index < reservas.length - 1) { %>
                        <form method="POST" action="/convocatoria/mover-reserva/<%= jogador.id %>/down" style="display: inline;">
                          <button type="submit" class="btn-seta btn-down" title="Mover para baixo">‚ñº</button>
                        </form>
                      <% } %>
                    </td>
                    <td class="status-reserva">
                      <span class="status-badge <%= index === 0 ? 'proximo' : 'reserva' %>">
                        <%= index === 0 ? 'Pr√≥ximo' : 'Reserva' %>
                      </span>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="5" class="no-data">Nenhum jogador nas reservas</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="convocatoria-stats">
      <div class="stats-summary">
        <div class="stat-item">
          <span class="stat-number"><%= convocados.length %></span>
          <span class="stat-label">Convocados</span>
        </div>
        <div class="stat-item">
          <span class="stat-number"><%= reservas.length %></span>
          <span class="stat-label">Reservas</span>
        </div>
        <div class="stat-item">
          <span class="stat-number"><%= convocados.length + reservas.length %></span>
          <span class="stat-label">Total Ativos</span>
        </div>
      </div>
    </div>

    <!-- Bot√£o para confirmar convocados e gerar equipas -->
    <% if (convocados.length >= 10) { %>
      <div class="confirmar-convocados-section">
        <h3>‚öΩ Formar Equipas</h3>
        <p>Com <strong><%= convocados.length %></strong> convocados confirmados, pode gerar automaticamente as equipas equilibradas.</p>
        <form method="POST" action="/convocatoria/confirmar-equipas" style="display: inline;" 
              onsubmit="return confirm('Gerar equipas equilibradas baseadas nas estat√≠sticas dos jogadores?')">
          <button type="submit" class="btn btn-success btn-large">
            üèÜ Confirmar Convocados & Gerar Equipas
          </button>
        </form>
      </div>
    <% } %>

    <!-- Se√ß√£o de Equipas Equilibradas -->
    <% if (typeof equipas !== 'undefined' && equipas) { %>
      <div class="equipas-section">        <h3>üèüÔ∏è Equipas Equilibradas</h3>
        <p class="equipas-info">Equipas geradas automaticamente baseadas na <strong>percentagem de vit√≥rias</strong> dos jogadores para m√°ximo equil√≠brio.</p>
        
        <div class="equipas-container">
          <!-- Equipa 1 - Verde Fluorescente -->
          <div class="equipa-card equipa-verde">
            <div class="equipa-header">
              <h4>üü¢ Equipa 1 - Coletes Verdes</h4>              <div class="equipa-stats">
                <span>% Vit√≥rias: <%= equipas.equipa1.percentagem_vitorias_media.toFixed(1) %>%</span>
                <span>Pontos: <%= equipas.equipa1.pontos_totais %></span>
              </div>
            </div>
            <div class="jogadores-equipa">
              <% equipas.equipa1.jogadores.forEach((jogador, index) => { %>                <div class="jogador-equipa-item" data-jogador-id="<%= jogador.id %>" data-equipa="1">
                  <span class="jogador-posicao"><%= index + 1 %>.</span>
                  <span class="jogador-nome"><%= jogador.nome %></span>
                  <span class="jogador-pontos"><%= (jogador.percentagem_vitorias || 0).toFixed(1) %>%</span>
                  <button class="btn-trocar" onclick="prepararTroca('<%= jogador.id %>', 1)">üîÑ</button>
                </div>
              <% }) %>
            </div>
          </div>

          <!-- Equipa 2 - Vermelho -->
          <div class="equipa-card equipa-vermelha">
            <div class="equipa-header">
              <h4>üî¥ Equipa 2 - Coletes Vermelhos</h4>              <div class="equipa-stats">
                <span>% Vit√≥rias: <%= equipas.equipa2.percentagem_vitorias_media.toFixed(1) %>%</span>
                <span>Pontos: <%= equipas.equipa2.pontos_totais %></span>
              </div>
            </div>
            <div class="jogadores-equipa">
              <% equipas.equipa2.jogadores.forEach((jogador, index) => { %>                <div class="jogador-equipa-item" data-jogador-id="<%= jogador.id %>" data-equipa="2">
                  <span class="jogador-posicao"><%= index + 1 %>.</span>
                  <span class="jogador-nome"><%= jogador.nome %></span>
                  <span class="jogador-pontos"><%= (jogador.percentagem_vitorias || 0).toFixed(1) %>%</span>
                  <button class="btn-trocar" onclick="prepararTroca('<%= jogador.id %>', 2)">üîÑ</button>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- Bot√µes de a√ß√£o para as equipas -->
        <div class="equipas-actions">
          <form method="POST" action="/convocatoria/reequilibrar-equipas" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
              üîÑ Reequilibrar Automaticamente
            </button>
          </form>
          <form method="POST" action="/convocatoria/salvar-equipas" style="display: inline;"
                onsubmit="return confirm('Salvar estas equipas para o pr√≥ximo jogo?')">
            <button type="submit" class="btn btn-primary">
              üíæ Salvar Equipas
            </button>
          </form>
        </div>
      </div>
    <% } %>
  </main>
  <script>
    // Confirma√ß√£o para marcar falta
    function marcarFalta(jogadorId, nomeJogador) {
      if (confirm(`Tem certeza que deseja marcar ${nomeJogador} como faltoso?\n\nEle ser√° movido para o final das reservas e o primeiro reserva ser√° promovido.`)) {
        document.getElementById(`form-falta-${jogadorId}`).submit();
      }
    }

    // Funcionalidade de trocas entre equipas
    let jogadorSelecionado = null;
    
    function prepararTroca(jogadorId, equipaAtual) {
      if (jogadorSelecionado === null) {
        // Primeiro jogador selecionado
        jogadorSelecionado = { id: jogadorId, equipa: equipaAtual };
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.add('selecionado-para-troca');
        alert('Jogador selecionado! Agora clique no jogador da outra equipa para fazer a troca.');
      } else if (jogadorSelecionado.id === jogadorId) {
        // Cancelar sele√ß√£o
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = null;
        alert('Sele√ß√£o cancelada.');
      } else if (jogadorSelecionado.equipa === equipaAtual) {
        // Mesma equipa - cancelar e selecionar novo
        document.querySelector(`[data-jogador-id="${jogadorSelecionado.id}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = { id: jogadorId, equipa: equipaAtual };
        document.querySelector(`[data-jogador-id="${jogadorId}"]`).classList.add('selecionado-para-troca');
        alert('Novo jogador selecionado! Clique em um jogador da outra equipa para fazer a troca.');
      } else {
        // Fazer a troca
        if (confirm('Confirmar troca entre os jogadores selecionados?')) {
          trocarJogadores(jogadorSelecionado.id, jogadorId);
        }
        // Limpar sele√ß√£o
        document.querySelector(`[data-jogador-id="${jogadorSelecionado.id}"]`).classList.remove('selecionado-para-troca');
        jogadorSelecionado = null;
      }
    }
    
    function trocarJogadores(jogadorId1, jogadorId2) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/convocatoria/trocar-jogadores';
      
      const input1 = document.createElement('input');
      input1.type = 'hidden';
      input1.name = 'jogador1';
      input1.value = jogadorId1;
      
      const input2 = document.createElement('input');
      input2.type = 'hidden';
      input2.name = 'jogador2';
      input2.value = jogadorId2;
      
      form.appendChild(input1);
      form.appendChild(input2);
      document.body.appendChild(form);
      form.submit();
    }

    // Auto-refresh da p√°gina a cada 30 segundos para mostrar atualiza√ß√µes
    setTimeout(function() {
      location.reload();
    }, 30000);
  </script>
</body>
</html>
